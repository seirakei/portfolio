function random(min,max){return min||(min=1),max||(max=min,min=0),Math.random()*(max-min)+min}function smoothstep(min,max,value){var x=Math.max(0,Math.min(1,(value-min)/(max-min)));return x*x*(3-2*x)}function customCurve(x){return smoothstep(0,.15,x)*(1-Math.pow(Math.max(0,2*Math.abs(x)-1),10))}importScripts("./cannon.js");let world=new CANNON.World;world.broadphase=new CANNON.SAPBroadphase(world),world.gravity.set(0,0,0);const worldPoint=new CANNON.Vec3(0,0,0),sphereMass=300;let sphereShape=new CANNON.Sphere(1),sphereMaterial=new CANNON.Material("");sphereMaterial.friction=0;let spheres=[],moveBody=new CANNON.Body({mass:300,shape:new CANNON.Sphere(1),position:new CANNON.Vec3(0,0,0),fixedRotation:!0}),body,scale,age,life,p,q;function resetBody(body){return body.position.set(moveBody.position.x+random(-1,1),moveBody.position.y+random(-1,1),moveBody.position.z+random(-1,1)),body.quaternion.setFromAxisAngle(new CANNON.Vec3(random(1),random(1),random(1)),random(-180,180)),body.applyLocalImpulse(new CANNON.Vec3(30,30,30),new CANNON.Vec3(random(-30,30),random(-30,30),random(-30,30))),body.shapes[0].radius=.001,body}world.addBody(moveBody);let attractForce=new CANNON.Vec3;self.onmessage=function(e){let positions=e.data.positions,quaternions=e.data.quaternions,scales=e.data.scales;if(moveBody.position.set(e.data.mouse.x,e.data.mouse.y,e.data.mouse.z),e.data.create){let i=spheres.length;body=new CANNON.Body({mass:300,shape:new CANNON.Sphere(1),angularDamping:.2,linearDamping:.01,material:sphereMaterial}),body=this.resetBody(body),spheres.push(body),scales[4*i+0]=.001,scales[4*i+1]=0,scales[4*i+2]=random(50,500),scales[4*i+3]=0,world.addBody(body)}world.step(e.data.dt);for(var i=0;i<spheres.length;i++)body=spheres[i],scale=scales[4*i+0],age=scales[4*i+1],life=scales[4*i+2],scale=customCurve(age/life)*this.Math.max(1-life/500,.5),age++,age>life&&(scale=.001,age=0,life=random(50,500),body=this.resetBody(body)),body.shapes[0].radius=scale,attractForce.set(700*(e.data.mouse.x-body.position.x),700*(e.data.mouse.y-body.position.y),700*(e.data.mouse.z-body.position.z)),body.applyForce(attractForce,worldPoint),p=body.position,q=body.quaternion,positions[3*i+0]=p.x,positions[3*i+1]=p.y,positions[3*i+2]=p.z,quaternions[4*i+0]=q.x,quaternions[4*i+1]=q.y,quaternions[4*i+2]=q.z,quaternions[4*i+3]=q.w,scales[4*i+0]=scale,scales[4*i+1]=age,scales[4*i+2]=life,scales[4*i+3]=body.velocity.clone().length();self.postMessage({create:e.data.create,positions:positions,quaternions:quaternions,scales:scales},[positions.buffer,quaternions.buffer,scales.buffer])};